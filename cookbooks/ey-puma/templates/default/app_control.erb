#!/usr/bin/sudo bash
# Auto-generated by Chef; your changes will be overwritten!

# Pull in a full environment and include some configuration of said commands.

# This can be ran by deploy user or root

source /etc/profile
source /data/<%= @app_name %>/shared/config/env
<% if @customvar %>
source /data/<%= @app_name %>/shared/config/env.custom
<% end %>
<% if @cloudvar %>
source /data/<%= @app_name %>/shared/config/env.cloud
<% end %>


ACTION="$1"

is_running() {
  
  if [[ `systemctl status puma_<%= @app_name %> |grep running` ]]; then return 0; fi
  return 1
}


status() {
    cd ${current_path}
    pumactl -S /var/run/engineyard/<%= @app_name %>/puma_<%= @app_name %>.state stats
}

start() {
  if is_running ; then
    echo "ERROR: Puma for <%= @app_name %> is already running"
    exit 1
  fi

  systemctl start puma_<%= @app_name %>.socket puma_<%= @app_name %>.service

}

deploy() {
    if is_running ; then
      echo "Hot deploying Puma for ${application}"
      cd ${current_path}
      pumactl -S  /var/run/engineyard/<%= @app_name %>/puma_<%= @app_name %>.state phased-restart && echo " phased-restart deploy in progress."
    else
      start
    fi
}

stop() {
  if is_running ; then
    echo "Stopping Puma for ${application} ..."
    systemctl stop puma_<%= @app_name %>.socket puma_<%= @app_name %>.service
    exit 1
  else
    echo "ERROR: Doesn't seem puma is running for <%= @app_name %>"
    exit 1
  fi
}

restart() {
  systemctl restart puma_<%= @app_name %>.socket puma_<%= @app_name %>.service
}


case "$ACTION" in
  deploy)
    deploy
    ;;
  stop)
    stop
    ;;
  start)
    start
    ;;
  status)
    status
    ;;
  hot_restart)
    deploy
    ;;
  hard_restart)
    restart
    ;;
  *)
    echo "Usage: $0 {start|stop|status|hot_restart|hard_restart|deploy}"
    exit 1
    ;;
esac

exit 0
